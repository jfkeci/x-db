---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_TITLE } from '../../consts';

const exercises = await getCollection('exercises');

const difficultyColors: Record<string, string> = {
	'Beginner': 'bg-green-500/20 text-green-300',
	'Intermediate': 'bg-yellow-500/20 text-yellow-300',
	'Advanced': 'bg-red-500/20 text-red-300',
};

// Get unique categories from exercises
const categories = [...new Set(exercises.map(e => e.data.category))].sort();

// Get unique muscle groups from all exercises
const muscleGroups = [...new Set(exercises.flatMap(e => e.data.muscleGroups))].sort();
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Exercises | ${SITE_TITLE}`} description="Browse our collection of exercises with detailed instructions and tips." />
	</head>
	<body class="min-h-screen flex flex-col bg-gradient-to-br from-purple-700 via-pink-600 to-orange-500 dark:from-gray-900 dark:via-purple-900 dark:to-gray-900 transition-colors duration-500">
		<!-- Animated background blobs -->
		<div class="fixed inset-0 overflow-hidden pointer-events-none">
			<div class="absolute -top-40 -left-40 w-80 h-80 bg-purple-400 dark:bg-purple-600 rounded-full mix-blend-multiply dark:mix-blend-soft-light filter blur-3xl opacity-70 animate-blob"></div>
			<div class="absolute top-40 -right-40 w-80 h-80 bg-yellow-300 dark:bg-pink-600 rounded-full mix-blend-multiply dark:mix-blend-soft-light filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
			<div class="absolute -bottom-40 left-1/2 w-80 h-80 bg-pink-400 dark:bg-blue-600 rounded-full mix-blend-multiply dark:mix-blend-soft-light filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
		</div>

		<Header />

		<div class="relative z-10 max-w-7xl mx-auto px-4 pt-24 pb-12 flex-1">
			<div class="text-center mb-12">
				<h1 class="text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg">Exercises</h1>
				<p class="text-lg text-white/80">Master proper form with our detailed exercise guides</p>
			</div>

			<div class="flex flex-col lg:flex-row gap-8 w-full">
				<!-- Sidebar -->
				<aside class="w-full lg:w-72 flex-shrink-0">
					<div class="glass-card rounded-3xl p-6 sticky top-24">
						<h2 class="text-lg font-semibold text-white mb-4">Search</h2>
						<input
							type="text"
							id="exercise-search"
							placeholder="Search exercises..."
							class="glass-input w-full px-4 py-3 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/30 transition-all"
						/>

						<details class="mt-6 group" open>
							<summary class="text-md font-semibold text-white cursor-pointer list-none flex items-center justify-between py-2 hover:text-white/80 transition-colors">
								<span>Categories</span>
								<svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
								</svg>
							</summary>
							<ul class="space-y-2 mt-3">
								<li>
									<button data-category="all" class="category-filter active flex items-center gap-3 w-full px-4 py-2 rounded-xl text-white/70 hover:text-white hover:bg-white/10 transition-all text-left">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
										All Categories
									</button>
								</li>
								{categories.map((category) => (
									<li>
										<button data-category={category} class="category-filter flex items-center gap-3 w-full px-4 py-2 rounded-xl text-white/70 hover:text-white hover:bg-white/10 transition-all text-left">
											<span class="w-1.5 h-1.5 rounded-full bg-current"></span> {category}
										</button>
									</li>
								))}
							</ul>
						</details>

						<details class="mt-6 group" open>
							<summary class="text-md font-semibold text-white cursor-pointer list-none flex items-center justify-between py-2 hover:text-white/80 transition-colors">
								<span>Muscle Groups</span>
								<svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
								</svg>
							</summary>
							<ul class="space-y-2 mt-3 max-h-64 overflow-y-auto">
								<li>
									<button data-muscle="all" class="muscle-filter active flex items-center gap-3 w-full px-4 py-2 rounded-xl text-white/70 hover:text-white hover:bg-white/10 transition-all text-left">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
										All Muscles
									</button>
								</li>
								{muscleGroups.map((muscle) => (
									<li>
										<button data-muscle={muscle} class="muscle-filter flex items-center gap-3 w-full px-4 py-2 rounded-xl text-white/70 hover:text-white hover:bg-white/10 transition-all text-left">
											<span class="w-1.5 h-1.5 rounded-full bg-current"></span> {muscle}
										</button>
									</li>
								))}
							</ul>
						</details>

						<div class="mt-8 p-4 rounded-2xl bg-white/10">
							<p class="text-white/60 text-sm">
								<span id="exercise-count" class="text-2xl font-bold text-white block">{exercises.length}</span>
								exercises available
							</p>
						</div>
					</div>
				</aside>

				<!-- Main Content -->
				<main class="flex-1">
					<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="exercises-grid">
						{exercises.map((exercise) => (
							<a
								href={`${import.meta.env.BASE_URL}/exercises/${exercise.id}/`}
								class="group exercise-card"
								data-name={exercise.data.name.toLowerCase()}
								data-category={exercise.data.category}
								data-muscles={exercise.data.muscleGroups.join(',')}
							>
								<article class="glass-card rounded-3xl p-6 h-full hover:scale-[1.02] hover:bg-white/30 dark:hover:bg-white/15 transition-all duration-300">
									<div class="flex items-start justify-between mb-4">
										<Image src={exercise.data.icon} alt={exercise.data.name} class="w-12 h-12" />
										<span class={`px-3 py-1 rounded-full text-xs font-medium ${difficultyColors[exercise.data.difficulty]}`}>
											{exercise.data.difficulty}
										</span>
									</div>

									<h2 class="text-xl font-bold text-white mb-2 group-hover:text-white transition-colors">
										{exercise.data.name}
									</h2>

									<p class="text-white/60 text-sm mb-4 line-clamp-2">
										{exercise.data.description}
									</p>

									<div class="flex flex-wrap gap-2 mb-4">
										{exercise.data.muscleGroups.slice(0, 3).map((muscle) => (
											<span class="glass px-2 py-1 rounded-lg text-xs text-white/70">
												{muscle}
											</span>
										))}
										{exercise.data.muscleGroups.length > 3 && (
											<span class="glass px-2 py-1 rounded-lg text-xs text-white/70">
												+{exercise.data.muscleGroups.length - 3}
											</span>
										)}
									</div>

									<div class="flex items-center gap-2 text-white font-medium group-hover:gap-3 transition-all">
										View details
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
										</svg>
									</div>
								</article>
							</a>
						))}
					</div>

					<div id="no-results" class="hidden text-center py-12">
						<p class="text-white/60 text-lg">No exercises match your filters</p>
					</div>
				</main>
			</div>
		</div>

		<script>
			const searchInput = document.getElementById('exercise-search') as HTMLInputElement;
			const categoryButtons = document.querySelectorAll('.category-filter');
			const muscleButtons = document.querySelectorAll('.muscle-filter');
			const exerciseCards = document.querySelectorAll('.exercise-card');
			const exerciseCount = document.getElementById('exercise-count');
			const noResults = document.getElementById('no-results');
			const exercisesGrid = document.getElementById('exercises-grid');

			let activeCategory = 'all';
			let activeMuscle = 'all';
			let searchTerm = '';

			function filterExercises() {
				let visibleCount = 0;

				exerciseCards.forEach((card) => {
					const name = card.getAttribute('data-name') || '';
					const category = card.getAttribute('data-category') || '';
					const muscles = card.getAttribute('data-muscles') || '';

					const matchesSearch = name.includes(searchTerm.toLowerCase());
					const matchesCategory = activeCategory === 'all' || category === activeCategory;
					const matchesMuscle = activeMuscle === 'all' || muscles.includes(activeMuscle);

					if (matchesSearch && matchesCategory && matchesMuscle) {
						(card as HTMLElement).style.display = '';
						visibleCount++;
					} else {
						(card as HTMLElement).style.display = 'none';
					}
				});

				if (exerciseCount) {
					exerciseCount.textContent = visibleCount.toString();
				}

				if (noResults && exercisesGrid) {
					if (visibleCount === 0) {
						noResults.classList.remove('hidden');
						exercisesGrid.classList.add('hidden');
					} else {
						noResults.classList.add('hidden');
						exercisesGrid.classList.remove('hidden');
					}
				}
			}

			searchInput?.addEventListener('input', (e) => {
				searchTerm = (e.target as HTMLInputElement).value;
				filterExercises();
			});

			categoryButtons.forEach((button) => {
				button.addEventListener('click', () => {
					categoryButtons.forEach((b) => b.classList.remove('active', 'bg-white/10', 'text-white'));
					button.classList.add('active', 'bg-white/10', 'text-white');
					activeCategory = button.getAttribute('data-category') || 'all';
					filterExercises();
				});
			});

			muscleButtons.forEach((button) => {
				button.addEventListener('click', () => {
					muscleButtons.forEach((b) => b.classList.remove('active', 'bg-white/10', 'text-white'));
					button.classList.add('active', 'bg-white/10', 'text-white');
					activeMuscle = button.getAttribute('data-muscle') || 'all';
					filterExercises();
				});
			});

			// Initialize active states
			document.querySelector('.category-filter.active')?.classList.add('bg-white/10', 'text-white');
			document.querySelector('.muscle-filter.active')?.classList.add('bg-white/10', 'text-white');
		</script>

		<Footer />

		<style>
			@keyframes blob {
				0% { transform: translate(0px, 0px) scale(1); }
				33% { transform: translate(30px, -50px) scale(1.1); }
				66% { transform: translate(-20px, 20px) scale(0.9); }
				100% { transform: translate(0px, 0px) scale(1); }
			}
			.animate-blob {
				animation: blob 7s infinite;
			}
			.animation-delay-2000 {
				animation-delay: 2s;
			}
			.animation-delay-4000 {
				animation-delay: 4s;
			}

			/* Hide default details marker */
			details summary::-webkit-details-marker {
				display: none;
			}
		</style>
	</body>
</html>
